<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改资料 - 游戏陪玩服务平台</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #f0f0f0;
        }
        .header {
            background-color: #222;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .header .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00a8e8;
            margin-right: 30px;
        }
        .header .search-bar {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: #333;
            border-radius: 20px;
            padding: 5px 15px;
            max-width: 400px;
        }
        .header .search-bar input {
            background: none;
            border: none;
            outline: none;
            color: #f0f0f0;
            padding: 5px;
            flex-grow: 1;
            font-size: 16px;
        }
        .header .search-bar button {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 18px;
        }
        .header .user-nav {
            display: flex;
            align-items: center;
            margin-left: 30px;
        }
        .header .user-nav a {
            color: #f0f0f0;
            text-decoration: none;
            margin-left: 25px;
            font-size: 15px;
            transition: color 0.3s ease;
        }
        .header .user-nav a:hover {
            color: #00a8e8;
        }
        .header .user-nav .avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #555;
            margin-left: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: white;
        }

        .container {
            display: flex;
            padding: 20px;
            max-width: 1000px;
            margin: 20px auto;
            background-color: #222;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .sidebar {
            width: 200px;
            margin-right: 20px;
            padding-right: 20px;
            border-right: 1px solid #333;
        }
        .sidebar h3 {
            color: #00a8e8;
            margin-top: 0;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            margin-bottom: 10px;
        }
        .sidebar ul li a {
            text-decoration: none;
            color: #aaa;
            display: block;
            padding: 8px 0;
            transition: color 0.3s ease;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active {
            color: #00a8e8;
            font-weight: bold;
        }
        .main-content {
            flex-grow: 1;
            padding-left: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #333;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .section h2 {
            color: #00a8e8;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            background-color: #444;
            border: 1px solid #555;
            border-radius: 5px;
            color: #f0f0f0;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #00a8e8;
        }
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        .avatar-upload {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #555;
            margin-right: 20px;
            overflow: hidden;
            border: 2px solid #00a8e8;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-upload-btn {
            background-color: #00a8e8;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .avatar-upload-btn:hover {
            background-color: #0099d6;
        }
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #00a8e8;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0099d6;
        }
        .btn-secondary {
            background-color: #555;
            color: #f0f0f0;
        }
        .btn-secondary:hover {
            background-color: #666;
        }
        .success-message {
            background-color: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .error-message {
            background-color: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module">
        import { supabase } from '../src/supabase-config.js'
        import { UserService } from '../src/services/user-service.js'

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserProfile()
            setupEventListeners()
        })

        // 加载用户资料
        async function loadUserProfile() {
            try {
                // 获取当前会话
                const { data: { session }, error: sessionError } = await supabase.auth.getSession()
                
                if (sessionError) {
                    console.error('获取会话失败:', sessionError)
                    redirectToLogin()
                    return
                }

                if (!session) {
                    redirectToLogin()
                    return
                }

                const userId = session.user.id
                
                // 获取用户信息
                const userProfile = await UserService.getUserProfile(userId)
                
                // 填充表单数据
                populateForm(userProfile)
                
                // 更新导航栏头像
                const navAvatar = document.querySelector('.header .avatar')
                if (userProfile.username) {
                    navAvatar.textContent = userProfile.username.substring(0, 1)
                }
                
            } catch (error) {
                console.error('加载用户资料失败:', error)
                showError('加载用户资料失败，请刷新页面重试')
            }
        }

        // 填充表单数据
        function populateForm(userProfile) {
            // 用户名
            const usernameInput = document.getElementById('username')
            if (usernameInput && userProfile.username) {
                usernameInput.value = userProfile.username
            }

            // 真实姓名
            const realNameInput = document.getElementById('realName')
            if (realNameInput && userProfile.real_name) {
                realNameInput.value = userProfile.real_name
            }

            // 性别
            const genderSelect = document.getElementById('gender')
            if (genderSelect && userProfile.gender) {
                genderSelect.value = userProfile.gender
            }

            // 年龄
            const ageInput = document.getElementById('age')
            if (ageInput && userProfile.age) {
                ageInput.value = userProfile.age
            }

            // 头像预览
            const avatarPreview = document.querySelector('.avatar-preview img')
            if (avatarPreview && userProfile.avatar_url) {
                avatarPreview.src = userProfile.avatar_url
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 个人资料表单提交
            const profileForm = document.getElementById('profileForm')
            if (profileForm) {
                profileForm.addEventListener('submit', handleFormSubmit)
            }

            // 密码修改表单提交
            const passwordForm = document.getElementById('passwordForm')
            if (passwordForm) {
                passwordForm.addEventListener('submit', handlePasswordChange)
            }

            // 头像上传
            const avatarUploadBtn = document.querySelector('.avatar-upload-btn')
            if (avatarUploadBtn) {
                avatarUploadBtn.addEventListener('click', handleAvatarUpload)
            }

            // 取消按钮
            const cancelBtn = document.querySelector('.btn-secondary')
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function(e) {
                    e.preventDefault()
                    window.location.href = 'profile.html'
                })
            }
        }

        // 处理表单提交
        async function handleFormSubmit(e) {
            e.preventDefault()
            
            try {
                // 获取当前会话
                const { data: { session }, error: sessionError } = await supabase.auth.getSession()
                if (sessionError || !session) {
                    showError('请先登录')
                    return
                }

                const userId = session.user.id
                
                // 收集表单数据
                const formData = {
                    username: document.getElementById('username').value.trim(),
                    real_name: document.getElementById('realName').value.trim(),
                    gender: document.getElementById('gender').value,
                    age: document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null
                }

                // 验证数据
                if (!formData.username) {
                    showError('请输入用户名')
                    return
                }

                // 更新用户资料
                await UserService.updateUserProfile(userId, formData)
                
                showSuccess('资料更新成功！正在跳转...')
                
                // 立即跳转回个人资料页，并强制重新加载
                setTimeout(() => {
                    window.location.href = 'profile.html?refresh=' + Date.now()
                }, 1000)
                
            } catch (error) {
                console.error('更新资料失败:', error)
                showError('更新资料失败：' + error.message)
            }
        }

        // 处理密码修改
        async function handlePasswordChange(e) {
            e.preventDefault()
            
            try {
                // 获取表单数据
                const currentPassword = document.getElementById('currentPassword').value
                const newPassword = document.getElementById('newPassword').value
                const confirmPassword = document.getElementById('confirmPassword').value

                // 验证数据
                if (!currentPassword || !newPassword || !confirmPassword) {
                    showError('请填写所有密码字段')
                    return
                }

                if (newPassword.length < 6) {
                    showError('新密码长度至少6位')
                    return
                }

                if (newPassword !== confirmPassword) {
                    showError('新密码和确认密码不一致')
                    return
                }

                if (newPassword === currentPassword) {
                    showError('新密码不能与当前密码相同')
                    return
                }

                // 修改密码
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                })

                if (error) {
                    // 检查是否是当前密码错误
                    if (error.message.includes('password') || error.message.includes('auth')) {
                        showError('当前密码错误，请重新输入')
                    } else {
                        throw error
                    }
                    return
                }

                showSuccess('密码修改成功！')
                
                // 清空密码表单
                document.getElementById('currentPassword').value = ''
                document.getElementById('newPassword').value = ''
                document.getElementById('confirmPassword').value = ''
                
            } catch (error) {
                console.error('修改密码失败:', error)
                showError('修改密码失败：' + error.message)
            }
        }

        // 处理头像上传
        async function handleAvatarUpload() {
            try {
                // 创建文件输入元素
                const fileInput = document.createElement('input')
                fileInput.type = 'file'
                fileInput.accept = 'image/*'
                
                fileInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0]
                    if (!file) return

                    // 验证文件类型和大小
                    if (!file.type.startsWith('image/')) {
                        showError('请选择图片文件')
                        return
                    }
                    
                    if (file.size > 5 * 1024 * 1024) { // 5MB限制
                        showError('图片大小不能超过5MB')
                        return
                    }

                    // 上传头像到Supabase存储
                    await uploadAvatar(file)
                })
                
                fileInput.click()
                
            } catch (error) {
                console.error('头像上传失败:', error)
                showError('头像上传失败：' + error.message)
            }
        }

        // 上传头像
        async function uploadAvatar(file) {
            try {
                const { data: { session }, error: sessionError } = await supabase.auth.getSession()
                if (sessionError || !session) {
                    showError('请先登录')
                    return
                }

                const userId = session.user.id
                
                // 生成唯一文件名
                const fileExt = file.name.split('.').pop()
                const fileName = `${userId}/avatar.${fileExt}`
                
                // 上传文件到Supabase存储
                const { data, error } = await supabase.storage
                    .from('avatars')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    })

                if (error) throw error

                // 获取文件公共URL
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName)

                // 更新用户头像URL
                await UserService.updateUserProfile(userId, { avatar_url: publicUrl })
                
                // 更新预览
                const avatarPreview = document.querySelector('.avatar-preview img')
                if (avatarPreview) {
                    avatarPreview.src = publicUrl + '?t=' + new Date().getTime() // 添加时间戳避免缓存
                }
                
                showSuccess('头像上传成功！')
                
            } catch (error) {
                console.error('上传头像失败:', error)
                showError('上传头像失败：' + error.message)
            }
        }

        // 重定向到登录页
        function redirectToLogin() {
            alert('请先登录')
            window.location.href = 'login.html'
        }

        // 显示成功消息
        function showSuccess(message) {
            const successDiv = document.querySelector('.success-message')
            if (successDiv) {
                successDiv.textContent = message
                successDiv.style.display = 'block'
                
                // 隐藏错误消息
                const errorDiv = document.querySelector('.error-message')
                if (errorDiv) {
                    errorDiv.style.display = 'none'
                }
            }
        }

        // 显示错误消息
        function showError(message) {
            const errorDiv = document.querySelector('.error-message')
            if (errorDiv) {
                errorDiv.textContent = message
                errorDiv.style.display = 'block'
                
                // 隐藏成功消息
                const successDiv = document.querySelector('.success-message')
                if (successDiv) {
                    successDiv.style.display = 'none'
                }
            }
        }
    </script>
</head>
<body>
    <div class="header">
        <div class="logo">游戏陪玩</div>
        <div class="search-bar">
            <input type="text" placeholder="搜索陪玩、俱乐部、游戏...">
            <button><i class="fas fa-search"></i></button>
        </div>
        <div class="user-nav">
            <a href="index.html">首页</a>
            <a href="order.html">我的订单</a>
            <a href="profile.html">个人中心</a>
            <a href="login.html">登录/注册</a>
            <div class="avatar">我</div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h3>个人中心</h3>
            <ul>
                <li><a href="profile.html">个人资料</a></li>
                <li><a href="edit_profile.html" class="active">修改资料</a></li>
                <li><a href="profile.html">钱包管理</a></li>
                <li><a href="chat.html">客服消息</a></li>
                <li><a href="login.html">退出登录</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="success-message"></div>
            <div class="error-message"></div>

            <div class="section">
                <h2>修改个人资料</h2>
                
                <form id="profileForm">
                    <div class="avatar-upload">
                        <div class="avatar-preview">
                            <img src="https://via.placeholder.com/80?text=头像" alt="头像预览">
                        </div>
                        <button type="button" class="avatar-upload-btn">
                            <i class="fas fa-camera"></i> 更换头像
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="username">用户名 *</label>
                        <input type="text" id="username" name="username" required maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="realName">真实姓名</label>
                        <input type="text" id="realName" name="realName" maxlength="50">
                    </div>

                    <div class="form-group">
                        <label for="gender">性别</label>
                        <select id="gender" name="gender">
                            <option value="">请选择</option>
                            <option value="male">男</option>
                            <option value="female">女</option>
                            <option value="other">其他</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="age">年龄</label>
                        <input type="number" id="age" name="age" min="1" max="120">
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存修改
                        </button>
                        <button type="button" class="btn btn-secondary">
                            <i class="fas fa-times"></i> 取消
                        </button>
                    </div>
                </form>
            </div>

            <div class="section">
                <h2>修改密码</h2>
                
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">当前密码 *</label>
                        <input type="password" id="currentPassword" name="currentPassword" required minlength="6">
                    </div>

                    <div class="form-group">
                        <label for="newPassword">新密码 *</label>
                        <input type="password" id="newPassword" name="newPassword" required minlength="6" placeholder="至少6位字符">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">确认新密码 *</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-key"></i> 修改密码
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>
</html>